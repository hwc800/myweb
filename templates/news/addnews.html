

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>添加节目</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../static/layui/css/layui.css" media="all">
    <script type="text/javascript">
        window.UEDITOR_HOME_URL = "/include/ueditor/";
        //var fenxiaoPriceNum=0;
    </script>

    <script type="text/javascript" charset="utf-8" src="/include/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="/include/ueditor/ueditor.all_news.js"> </script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="/include/ueditor/lang/zh-cn/zh-cn.js"></script>

    <style type="text/css">
        .zbspan{
            margin:0px 10px;
        }
        .zbspan font{
            color:red;
            margin-right: 5px;
            cursor: pointer;
        }
    </style>

</head>
<body>

<div class="layui-form" lay-filter="layuiadmin-app-form-list" id="layuiadmin-app-form-list" style="padding: 20px 30px 0 0;">
    <div class="layui-form-item" id="itemtype_div">
        <label class="layui-form-label">类型</label>
        <div class="layui-input-inline" style="width: 150px;">
            <select name="itemtype_id"  id="itemtype_id" lay-filter="itemtype_id">
            </select>
         </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">归属分类</label>
        <div class="layui-input-inline">
            <select name="typeid"  id="typeid" lay-search="">
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新闻标题</label>
        <div class="layui-input-inline" style="width:400px;">
            <input type="hidden" id="newsid" name="newsid" lay-verify="required" autocomplete="off" class="layui-input" value="0">
            <input type="text" id="newstitle" name="newstitle" lay-verify="required" placeholder="新闻标题" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">封面图</label>
        <div class="layui-input-inline">
            <p id="demo2"></p>
            <div class="file-box">
                <img id="preview" class="layui-upload-img" style="width: 60px;"/>
                <input type="file" name="file" class="input_file2" id = "input_file2" accept="image/gif,image/*" onchange="imgPreview(this)">
                <button type="button" class="layui-btn" id="btnLogo2" onclick="uploadpic()">上传图片</button>
            </div>

            <input type="hidden" id="newsimg" name="newsimg" class="layui-input">
            <p id="errText"></p>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">新闻副标题</label>
        <div class="layui-input-inline" style="width:400px;">
            <input type="text" id="newssubhead" name="newssubhead"   placeholder="新闻副标题" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">关键字</label>
        <div class="layui-input-inline" style="width:400px;">
            <input type="text" id="newskeyword" name="newskeyword"   placeholder="关键字" autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">开始时间</label>
        <div class="layui-input-inline">
            <input type="text" class="layui-input" id="newstime" name="newstime" placeholder="yyyy-MM-dd HH:mm:ss">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">简介</label>
        <div class="layui-input-inline">
            <textarea type="text" id="newsbrief" name="newsbrief" style="width: 500px; height: 100px;"   placeholder="简介" autocomplete="off" class="layui-input"></textarea>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">新闻内容</label>
        <div class="layui-input-inline" name="newscontent" id="newscontent" style="width: 600px; height:300px;margin-left: 110px;">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">发布人</label>
        <div class="layui-input-inline">
            <input type="text" id="newssender" name="newssender"    autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">点击量</label>
        <div class="layui-input-inline">
            <input type="text" id="newshits" name="newshits"  autocomplete="off" class="layui-input">
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">前端颜色</label>
            <div class="layui-input-inline">
                <input type="text" id="front_color" name="front_color"  placeholder="前端颜色" autocomplete="off" class="layui-input" style="width: 70%;float: left;">
                <span id="fcolor" style="width: 20%;float: left;">颜色</span>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">字体样式</label>
            <input type="checkbox" name="fstyle" value="font-size:14px;" lay-skin="primary" title="14像素">
            <input type="checkbox" name="fstyle" value="font-size:16px;" lay-skin="primary" title="16像素">
            <input type="checkbox" name="fstyle" value="font-size:18px;" lay-skin="primary" title="18像素">
            <input type="checkbox" name="fstyle" value="font-size:24px;" lay-skin="primary" title="24像素">
            <input type="checkbox" name="fstyle" value="font-weight:bold;" lay-skin="primary" title="加粗">
            <input type="hidden" id="front_style" name="front_style" autocomplete="off" class="layui-input" value="">
    </div>
    <div class="layui-inline">
        <label class="layui-form-label">是否推荐</label>
        <div class="layui-input-inline">
            <div class="layui-input-inline">
                <select name="istj"  id="istj" lay-verify="required">
                    <option value="0">普通</option>
                    <option value="1">推荐</option>
                </select>
            </div>
        </div>
    </div>

    <div class="layui-inline">
        <label class="layui-form-label">是否审核</label>
        <div class="layui-input-inline">
            <input type="checkbox" lay-verify="required" lay-filter="isshow" checked id="isshow" name="isshow" lay-skin="switch" lay-text="是|否">
        </div>
    </div>
    <div class="layui-form-item layui-hide">
        <input type="button" lay-submit lay-filter="layuiadmin-app-form-submit" id="layuiadmin-app-form-submit" value="确认添加">
        <input type="button" lay-submit lay-filter="layuiadmin-app-form-edit" id="layuiadmin-app-form-edit" value="确认编辑">
    </div>
</div>

<script src="../static/layui/layui.js"></script>
<script src="../static/js/common.js"></script>
<script src="../static/js/jquery-1.7.1.min.js"></script>
<script>
    var timestamp = (new Date()).valueOf();
    document.write('<script language="javascript" src="/json/data/sporttype.js?v=' + timestamp + '"><\/script\>');
</script>
<script>
    //实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('newscontent');
    var olddata;
    var isout=false;//参数传入判断是否外部弹出
    //修改初始化数据传入
    function child(data,out){
        olddata=data;
        if(out!=null&&out!=undefined){isout=out;}
    }
    //将checke拼接为"value1,value2,value3"
    function GetCheckboxValues(Name) {
        var result = [];
        $("[name='" + Name + "']:checkbox").each(function () {
            if ($(this).is(":checked")) {
                result.push($(this).val());
            }
        });
        return result.join(",");
    };

    layui.config({
        base: '../static/', //静态资源所在路径
        catch:false
        }).extend({
            index: 'lib/index'  //主入口模块
        }).use(['index','upload','laydate','colorpicker', 'form'], function(){
        var $ = layui.$
            ,upload = layui.upload
            ,laydate = layui.laydate
            ,colorpicker = layui.colorpicker
            ,form = layui.form;

        //日期时间范围
        laydate.render({
            elem: '#newstime'
            ,type: 'datetime'
            , value:local_date(new Date())
        });

        colorpicker.render({
            elem: '#fcolor'
            ,change: function(color){
                $("#front_color").val(color);
            }
        });

        $("#newshits").val(Math.floor(Math.random() * (10000 - 3000 + 1)) + 3000);
        //绑定数据
        if (olddata != undefined) {
            var datas = eval(olddata);
            form.val('layuiadmin-app-form-list', {
                "newsid": datas["newsid"] // "name": "value"
                , "newstitle": datas["newstitle"]
                , "newssubhead": datas["newssubhead"]
                , "newskeyword": datas["newskeyword"]
                , "newssender": datas["newssender"]
                , "newshits": datas["newshits"]
                , "newsbrief": datas["newsbrief"]
                , "isshow": datas["isshow"] == 0 ? true : false //审核，0是，1不是
                , "front_color": datas["front_color"]
                , "newsimg": datas["newsimg"]
            });
            $("#preview").attr("src", datas["newsimg"]);
            UE.getEditor('newscontent').setContent(datas["newscontent"]+" ", false);
            $("#istj").val(datas["istj"]);
            $("#fcolor .layui-colorpicker-trigger-span").css("background",datas["front_color"]);
            laydate.render({
                elem: '#newstime'
                , type: 'datetime'
                , value:local_date(datas["newstime"])
            });

            //多选字体样式还原
            if(datas["front_style"]!=null&&datas["front_style"].length>0) {
                $("#front_style").val(datas["front_style"]);
                //拆分选中CheckBox
                var fstyle = datas["front_style"].split(",");
                for (var j = 0; j < fstyle.length; j++) {
                    var weekCheckbox = $("input[name='fstyle']");
                    for (var i = 0; i < weekCheckbox.length; i++) {
                        if (weekCheckbox[i].value == fstyle[j]) {
                            weekCheckbox[i].checked = true;
                        }
                    }
                }
            }
            form.render(); //刷新渲染
        }

        $.ajax({
            type: "POST",
            url: "/json/news/get_typelist.php?limit=5000&isshow=0",//请求路径 itemtype_id
            success: function (data) {
                var obj = JSON.parse(data);
                var html = '';
                var tid = 0;
                if (olddata != undefined) {
                    var datas = eval(olddata);
                    tid=datas["typeid"];
                }
                if (obj["count"] > 0) {
                    for (var a = 0; a < obj["data"].length; a++) {
                        var obj2 = obj["data"][a];
                        if(tid==obj2.typeid){
                            html = html + ('<option value=' + obj2.typeid + ' selected>' + obj2.typename + '</option>');
                        }else {
                            html = html + ('<option value=' + obj2.typeid + '>' + obj2.typename + '</option>');
                        }
                    }
                }
                $('#typeid').html(html);
                form.render('select'); //刷新select选择框渲染
            }
        });



        //主动触发下拉
        $("#itemtypeid1_div").remove();
        $("#itemtypeid2_div").remove();

        var obj = (sporttype_js);
        if (obj["count"] > 0) {
            var html = '<option value ="" >请选择分类</option>';
            for (var a = 0; a < obj["data"].length; a++) {
                var obj2 = obj["data"][a];
                if(obj2.itemtype_id==0&&obj2.isshow==0) {
                    html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                }
            }

            $('#itemtype_id').append(html);
            if (olddata != undefined) {
                $("#itemtype_id").val(datas["itemtype_id"]);//初始值

                if (obj["count"] > 0) {
                    var html = '<div class="layui-input-inline" id="itemtypeid1_div" style="width: 150px;"><select name="itemtypeid1"  id="itemtypeid1" lay-filter="itemtypeid1" lay-search=""><option value ="" >请选择分类</option>';
                    for (var a = 0; a < obj["data"].length; a++) {
                        var obj2 = obj["data"][a];
                        if(obj2.itemtype_id==datas["itemtype_id"]&&obj2.itemtypeid1==0&&obj2.isshow==0) {
                            html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                        }
                    }
                    html = html + ('</select></div>');
                    $('#itemtype_div').append(html);
                    form.render(); //刷新渲染
                    //二级
                    if (obj["count"] > 0) {
                        var html = '<div class="layui-input-inline" style="width: 150px;" id="itemtypeid2_div"><select name="itemtypeid2"  id="itemtypeid2" lay-filter="itemtypeid2" lay-search=""><option value ="" >请选择分类</option>';
                        for (var a = 0; a < obj["data"].length; a++) {
                            var obj2 = obj["data"][a];
                            if(obj2.itemtype_id==datas["itemtype_id"]&&obj2.itemtypeid1==datas["itemtypeid1"]&&obj2.isshow==0) {
                                html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                            }
                        }
                        html = html + ('</select></div>');
                        $('#itemtype_div').append(html);
                        form.render(); //刷新渲染
                    }
                    $("#itemtypeid2").val(datas["itemtypeid2"]);
                    form.render(); //刷新渲染

                    $("#itemtypeid1").val(datas["itemtypeid1"]);
                    form.render(); //刷新渲染
                }
            }else{
                $("#itemtype_id").val(1348);//初始值
                var html = '<div class="layui-input-inline" id="itemtypeid1_div" style="width: 150px;"><select name="itemtypeid1"  id="itemtypeid1" lay-filter="itemtypeid1" lay-search=""><option value ="" >请选择分类</option>';
                for (var a = 0; a < obj["data"].length; a++) {
                    var obj2 = obj["data"][a];
                    if(obj2.itemtype_id==1348&&obj2.itemtypeid1==0&&obj2.isshow==0) {
                        html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                    }
                }
                html = html + ('</select></div>');
                $('#itemtype_div').append(html);
            }
            form.render("select"); //刷新渲染
        }


        //类型下拉触发事件
        form.on('select(itemtype_id)', function(data){
           $("#itemtypeid1_div").remove();
           $("#itemtypeid2_div").remove();
            var itemtypeid=$("#itemtype_id").find("option:selected").val();

            var obj = (sporttype_js);
            if (obj["count"] > 0) {
                var html = '<div class="layui-input-inline" id="itemtypeid1_div" style="width: 150px;"><select name="itemtypeid1"  id="itemtypeid1" lay-filter="itemtypeid1" lay-search=""><option value ="" >请选择分类</option>';
                for (var a = 0; a < obj["data"].length; a++) {
                    var obj2 = obj["data"][a];
                    if (obj2.itemtype_id == itemtypeid&&obj2.itemtypeid1==0 && obj2.isshow == 0) {
                        html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                    }
                }
                html = html + ('</select></div>');
                $('#itemtype_div').append(html);
                form.render(); //刷新渲染
            }
            $("#itemtype").val($("#itemtype_id").find("option:selected").text());
        });
        form.on('select(itemtypeid1)', function(data){
            $("#itemtypeid2_div").remove();
            var itemtid1=$("#itemtypeid1").find("option:selected").val();

            var obj =  (sporttype_js);
            if (obj["count"] > 0) {
                var html = '<div class="layui-input-inline" style="width: 150px;" id="itemtypeid2_div"><select name="itemtypeid2"  id="itemtypeid2" lay-filter="itemtypeid2" lay-search=""><option value ="" >请选择分类</option>';
                for (var a = 0; a < obj["data"].length; a++) {
                    var obj2 = obj["data"][a];
                    if (obj2.itemtypeid1 == itemtid1 && obj2.isshow == 0) {
                        html = html + ('<option value = ' + obj2.id + '>' + obj2.typename + '</option>');
                    }
                }
                html = html + ('</select></div>');
                $('#itemtype_div').append(html);
                form.render(); //刷新渲染
            }

        });

        //监听提交
        form.on('submit(layuiadmin-app-form-submit)', function(data){
            $("#front_show").val(GetCheckboxValues("fshow"));
            data.field.front_show=$("#front_show").val();
            $("#front_style").val(GetCheckboxValues("fstyle"));
            data.field.front_style=$("#front_style").val();
            data.field.newscontent=UE.getEditor('newscontent').getContent();
            var field = data.field; //获取提交的字段
            $.ajax({
                    type:'POST',
                    url:'/json/news/add_news.php',
                    data:field,
                    success:function(data)
                    {
                        if (checkqx(data)) {
                            if (isout) {
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭
                            } else {
                                //询问框
                                layer.confirm('添加数据成功，关闭当前页！', {
                                    btn: ['关闭', '取消'] //按钮
                                }, function () {
                                    //执行成功
                                    parent.layui.table.reload('LAY-app-content-list'); //重载表格
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                }, function () {
                                    parent.layui.table.reload('LAY-app-content-list'); //重载表格
                                });
                            }
                        }
                    },
                    error:function()
                    {
                        layer.msg("添加数据失败，请查询错误信息！");
                    }
                });
            parent.layui.table.reload('LAY-app-content-list'); //重载表格
        });

        //监听更新提交
        form.on('submit(layuiadmin-app-form-edit)', function(data){
            $("#front_show").val(GetCheckboxValues("fshow"));
            data.field.front_show=$("#front_show").val();
            $("#front_style").val(GetCheckboxValues("fstyle"));
            data.field.front_style=$("#front_style").val();
            data.field.newscontent=UE.getEditor('newscontent').getContent();
            var field = data.field; //获取提交的字段
            $.ajax({
                    type:'POST',
                    url:'/json/news/add_news.php?t=edit',
                    data:field,
                    success:function(data)
                    {
                        if (checkqx(data)) {
                            //询问框
                            layer.confirm('更新数据成功，关闭当前页！', {
                                btn: ['关闭', '取消'] //按钮
                            }, function () {
                                //执行成功
                                parent.layui.table.reload('LAY-app-content-list'); //重载表格
                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                parent.layer.close(index); //再执行关闭
                            }, function () {
                                parent.layui.table.reload('LAY-app-content-list'); //重载表格
                            });
                        }
                    },
                    error:function()
                    {
                        layer.msg("更新数据失败，请查询错误信息！");
                    }

                }

            );
        });
    })

    //时间统一格式化
    function local_date(time)
    {

        if(time==undefined || time==null ||time=='')
        {
            return '';
        }else
        {
            var date = new Date(time);
            var month = date.getMonth(time) + 1;
            var strDate = date.getDate(time);
            if (month >= 1 && month <= 9) {
                month = "0" + month;
            }
            if (strDate >= 0 && strDate <= 9) {
                strDate = "0" + strDate;
            }
            var currentDate = date.getFullYear() + "-" + month + "-" + strDate
                + " " + date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
            return currentDate;
        }
    }
</script>

<script>
    function uploadpic()
    {
        var formdata = new FormData();
        //formdata.append('name', 'uploadImage');
        var file1 = document.getElementById("input_file2");
        var file3 = file1.files[0];
        formdata.append('uploadImage', file3);
        //formdata.append('uploadImage', $('#input_file2')[0].files[0]);
        formdata.append('filename', 'testfile');
        $.ajax({
            type: "post",
            processData:false,
            contentType:false,
            //url: "http://www.zhaozhibo.com/json/common/upload_img.php?t=tvchannel",
            url:"//img.tianmaotv.cn/json/common/upload_img.php?t=news",  //就一个地址其他?后面什么的都不要加
            DataType: "jsonp", //定义为jsonp类型
            crossDomain: true,
            data: formdata,
            jsonCallback: "jsonpcallback",  //就是相当于前面例子中?cc=demo的demo,自己可以更改                      
            success: function (res)
            {//Jquery直接将结果在success中写出，不需要和原生js一样去自己定义回调函数
                //alert(res);
                jsonpcallback(res);
            }

        })
    }

    function jsonpcallback(res2){
        //如果上传失败\
        var res = JSON.parse(res2);
        if(res.code > 0){
            var demoText = $('#demoText');
            demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
            demoText.find('.demo-reload').on('click', function(){
                //uploadInst.upload();
                $('#demoText').html('');
            });
            return layer.msg('上传失败：'+res.msg);
        }
        //上传成功
        layer.msg("上传成功");
        $('#newsimg').val(res.msg);//赋值图片上传地址到隐藏域
        //alert(' pic address: '+res.msg);

    }


    function imgPreview(fileDom) {
        //判断是否支持FileReader
        if(window.FileReader) {
            var reader = new FileReader();
        } else {
            alert("您的设备不支持图片预览功能，如需该功能请升级您的设备！");
        }
        //获取文件
        var file = fileDom.files[0];
        var imageType = /^image\//;
        //是否是图片
        if(!imageType.test(file.type)) {
            alert("请选择图片！");
            return;
        }
        //读取完成
        reader.onload = function(e) {
            //获取图片dom
            var img = document.getElementById("preview");
            //图片路径设置为读取的图片
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
</script>
</body>
</html>